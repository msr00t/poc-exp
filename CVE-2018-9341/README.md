A Heap Buffer OOB Write critical vulnerability in libmpeg2 https://android.googlesource.com/platform/external/libmpeg2/

Fixed in June Android security bulletin https://android.googlesource.com/platform/external/libmpeg2/+/69ac35d37c0fcf43ac3dac6c99dbec5ecb258c41

Just found it in crash corpus junk when packing before leaving, forgot to check it half year ago....

**Build Prep**

one already compiled Android source tree

mmm external/libmpeg2

mmm external/libmpeg2/test

mpeg2dec --input poc --output /dev/null --num_frames -1

**ASAN report (X86 build)**

<pre>
Ittiam Decoder Version number: @(#)Id:MPEG2VDEC_eval Ver:01.00 Released by ITTIAM Build: Jul  3 2018 @ 07:53:17
=================================================================
==9197==ERROR: AddressSanitizer: heap-buffer-overflow on address 0xf53fefa0 at pc 0x081ad034 bp 0xfff5b7c8 sp 0xfff5b7bc
WRITE of size 8 at 0xf53fefa0 thread T0
    #0 0x81ad033 in impeg2_mc_fullx_halfy_8x8_sse42 /home/ipattern/mpeg2/common/x86/impeg2_inter_pred_sse42_intr.c:815:5
    #1 0x8181091 in impeg2d_mc_fullx_halfy /home/ipattern/mpeg2/decoder/impeg2d_mc.c:1122:9
    #2 0x817b739 in impeg2d_motion_comp /home/ipattern/mpeg2/decoder/impeg2d_mc.c:129:5
    #3 0x817b739 in impeg2d_dec_skip_p_mb /home/ipattern/mpeg2/decoder/impeg2d_mc.c:584
    #4 0x817f45f in impeg2d_dec_skip_mbs /home/ipattern/mpeg2/decoder/impeg2d_mc.c:735:9
    #5 0x818b786 in impeg2d_dec_pnb_mb_params /home/ipattern/mpeg2/decoder/impeg2d_pnb_pic.c:351:13
    #6 0x818c9c6 in impeg2d_dec_p_b_slice /home/ipattern/mpeg2/decoder/impeg2d_pnb_pic.c:542:19
    #7 0x8164b4d in impeg2d_dec_slice /home/ipattern/mpeg2/decoder/impeg2d_dec_hdr.c:900:15
    #8 0x81653e7 in impeg2d_dec_pic_data_thread /home/ipattern/mpeg2/decoder/impeg2d_dec_hdr.c:990:23
    #9 0x816a55a in impeg2d_dec_pic_data /home/ipattern/mpeg2/decoder/impeg2d_dec_hdr.c:1432:5
    #10 0x816d97b in impeg2d_process_video_bit_stream /home/ipattern/mpeg2/decoder/impeg2d_dec_hdr.c:1799:17
    #11 0x816e5bd in impeg2d_dec_frm /home/ipattern/mpeg2/decoder/impeg2d_decoder.c:220:19
    #12 0x815aefe in impeg2d_api_entity /home/ipattern/mpeg2/decoder/impeg2d_api_main.c:3488:17
    #13 0x814e823 in impeg2d_api_function /home/ipattern/mpeg2/decoder/impeg2d_api_main.c:1411:25
    #14 0x81b8b3e in main /home/ipattern/mpeg2/test/decoder/main.c:2886:19
    #15 0xf7537636 in __libc_start_main (/lib/i386-linux-gnu/libc.so.6+0x18636)
    #16 0x8061f87 in _start (/home/ipattern/mpeg2/mpeg2_fast+0x8061f87)

0xf53fefa0 is located 160 bytes to the right of 6178560-byte region [0xf4e1a800,0xf53fef00)
allocated by thread T0 here:
    #0 0x81067e4 in __interceptor_aligned_alloc.localalias.0 (/home/ipattern/mpeg2/mpeg2_fast+0x81067e4)
    #1 0x81b585e in app_aligned_malloc /home/ipattern/mpeg2/test/decoder/main.c:456:12
    #2 0x81b585e in main /home/ipattern/mpeg2/test/decoder/main.c:2164
    #3 0xf7537636 in __libc_start_main (/lib/i386-linux-gnu/libc.so.6+0x18636)

SUMMARY: AddressSanitizer: heap-buffer-overflow /home/ipattern/mpeg2/common/x86/impeg2_inter_pred_sse42_intr.c:815:5 in impeg2_mc_fullx_halfy_8x8_sse42
Shadow bytes around the buggy address:
  0x3ea7fda0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x3ea7fdb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x3ea7fdc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x3ea7fdd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x3ea7fde0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x3ea7fdf0: fa fa fa fa[fa]fa fa fa fa fa fa fa fa fa fa fa
  0x3ea7fe00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3ea7fe10: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3ea7fe20: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3ea7fe30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3ea7fe40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Heap right redzone:      fb
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack partial redzone:   f4
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==9197==ABORTING
</pre>
